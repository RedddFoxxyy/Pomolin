app-id: io.github.redddfoxxyy.pomolin
runtime: org.freedesktop.Platform
runtime-version: "24.08"
sdk: org.freedesktop.Sdk
sdk-extensions:
  - org.freedesktop.Sdk.Extension.openjdk

command: pomolin
finish-args:
  - --share=ipc
  - --socket=x11
  - --socket=pulseaudio
  - --device=dri
  - --filesystem=xdg-documents
  - --talk-name=org.freedesktop.Notifications
  - --talk-name=org.kde.StatusNotifierWatcher

modules:
  - name: openjdk
    buildsystem: simple
    build-commands:
      - /usr/lib/sdk/openjdk/install.sh

  - name: pomolin
    buildsystem: simple
    build-options:
      env:
        JAVA_HOME: /usr/lib/sdk/openjdk
        PATH: /usr/lib/sdk/openjdk/bin:/usr/bin:/bin
    #      build-args:
    #        - --share=network
    sources:
      - flatpak-sources.json

      - type: git
        url: https://github.com/RedddFoxxyy/Pomolin.git
        #        tag: v1.1.3
        branch: main
      #        dest: "."

      - type: file
        url: https://services.gradle.org/distributions/gradle-8.14.3-bin.zip
        sha256: bd71102213493060956ec229d946beee57158dbd89d0e62b91bca0fa2c5f3531
        dest: "gradle"

    build-commands:
      - mkdir -p /app/gradle
      - unzip gradle/gradle-8.14.3-bin.zip -d /app/gradle
      - mv /app/gradle/gradle-8.14.3/* /app/gradle

      # Create a Gradle init script that CLEARS all other repositories
      # and forces the use of the local offline repository.
      - |
        cat <<EOF > offline.gradle
        settingsEvaluated { settings ->
            settings.pluginManagement {
                repositories {
                    clear()
                    maven {
                        name = "FlatpakOfflineRepository"
                        url = uri("file:///run/build/pomolin-build/offline-repository")
                    }
                }
            }
        }
        allprojects {
          repositories {
            clear()
            maven {
              url 'file:///run/build/pomolin-build/offline-repository'
            }
          }
        }
        EOF

      #      - chmod +x ./gradlew
      #      - ./gradlew createReleaseDistributable
      #      - /app/gradle/bin/gradle --no-daemon createReleaseDistributable
      - /app/gradle/bin/gradle --no-daemon --init-script offline.gradle createReleaseDistributable

      - cp -r composeApp/build/compose/binaries/main-release/app/* /app/

      # Remove the invalid JVM argument from the app's config file
      - "sed -i '/--illegal-native-access=deny/d' /app/pomolin/lib/app/pomolin.cfg"

      - install -Dm644 packaging/io.github.redddfoxxyy.pomolin.desktop /app/share/applications/io.github.redddfoxxyy.pomolin.desktop
      - install -Dm644 packaging/io.github.redddfoxxyy.pomolin.svg /app/share/icons/hicolor/scalable/apps/io.github.redddfoxxyy.pomolin.svg
      - install -Dm644 packaging/io.github.redddfoxxyy.pomolin.metainfo.xml /app/share/metainfo/io.github.redddfoxxyy.pomolin.metainfo.xml

      - install -Dm755 packaging/pomolin-launcher.sh /app/bin/pomolin